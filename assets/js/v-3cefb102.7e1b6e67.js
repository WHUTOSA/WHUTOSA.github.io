(self.webpackChunkwulinks=self.webpackChunkwulinks||[]).push([[955],{958:(n,s,a)=>{"use strict";a.r(s),a.d(s,{data:()=>t});const t={key:"v-3cefb102",path:"/redisson/03-%E5%88%86%E5%B8%83%E5%BC%8F%E9%99%90%E6%B5%81%E5%99%A8/",title:"分布式限流器",lang:"ZH-cn",frontmatter:{title:"分布式限流器",type:"book",scopePath:"/redisson",sort:3},excerpt:"",headers:[{level:2,title:"本文目的",slug:"本文目的",children:[]},{level:2,title:"初识",slug:"初识",children:[]},{level:2,title:"RedissonRateLimiter 源码阅读",slug:"redissonratelimiter-源码阅读",children:[]},{level:2,title:"其它思考",slug:"其它思考",children:[{level:3,title:"关于 Redisson 所用数据结构的思考",slug:"关于-redisson-所用数据结构的思考",children:[]},{level:3,title:"时间差问题",slug:"时间差问题",children:[]},{level:3,title:"限流器配置改变的可见性问题",slug:"限流器配置改变的可见性问题",children:[]}]}]}},202:(n,s,a)=>{"use strict";a.r(s),a.d(s,{default:()=>Sn});var t=a(252);const e=a.p+"assets/img/2.7a84f8b4.png",o=(0,t.Wm)("h1",{id:"分布式限流器",tabindex:"-1"},[(0,t.Wm)("a",{class:"header-anchor",href:"#分布式限流器","aria-hidden":"true"},"#"),(0,t.Uk)(" 分布式限流器")],-1),c=(0,t.Wm)("h2",{id:"本文目的",tabindex:"-1"},[(0,t.Wm)("a",{class:"header-anchor",href:"#本文目的","aria-hidden":"true"},"#"),(0,t.Uk)(" 本文目的")],-1),m=(0,t.Wm)("p",null,[(0,t.Uk)("掌握 "),(0,t.Wm)("code",null,"RRateLimiter"),(0,t.Uk)(" 的使用并探究其实现细节。")],-1),l=(0,t.Wm)("h2",{id:"初识",tabindex:"-1"},[(0,t.Wm)("a",{class:"header-anchor",href:"#初识","aria-hidden":"true"},"#"),(0,t.Uk)(" 初识")],-1),p=(0,t.Wm)("p",null,[(0,t.Wm)("code",null,"RRateLimiter"),(0,t.Uk)(" 接口是 Redisson 提供的限流器：")],-1),k=(0,t.Wm)("div",{class:"language-java ext-java line-numbers-mode"},[(0,t.Wm)("pre",{class:"language-java"},[(0,t.Wm)("code",null,[(0,t.Wm)("span",{class:"token doc-comment comment"},[(0,t.Uk)("/**\n * 基于 redis 的限流器\n *\n * "),(0,t.Wm)("span",{class:"token keyword"},"@author"),(0,t.Uk)(" Nikita Koksharov\n *\n */")]),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"public"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"interface"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RRateLimiter"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"extends"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RRateLimiterAsync"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RExpirable"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token doc-comment comment"},[(0,t.Uk)("/**\n     * 初始化限流器的状态并将其配置存储到 redis 服务\n     *\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@param"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token parameter"},"mode"),(0,t.Uk)("             - 限流模式\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@param"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token parameter"},"rate"),(0,t.Uk)("             - 限流阈值\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@param"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token parameter"},"rateInterval"),(0,t.Uk)("     - 限流间隔\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@param"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token parameter"},"rateIntervalUnit"),(0,t.Uk)(" - 限流间隔的时间单位\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@return"),(0,t.Uk)(" 若设置成功则返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"true")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("，否则返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"false")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n     */")]),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"boolean"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"trySetRate"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token class-name"},"RateType"),(0,t.Uk)(" mode"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(" rate"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(" rateInterval"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RateIntervalUnit"),(0,t.Uk)(" rateIntervalUnit"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n    "),(0,t.Wm)("span",{class:"token doc-comment comment"},[(0,t.Uk)("/**\n     * 更新限流器的状态并将其配置存储到 redis 服务\n     *\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@param"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token parameter"},"mode"),(0,t.Uk)("             - 限流模式\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@param"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token parameter"},"rate"),(0,t.Uk)("             - 限流阈值\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@param"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token parameter"},"rateInterval"),(0,t.Uk)("     - 限流间隔\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@param"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token parameter"},"rateIntervalUnit"),(0,t.Uk)(" - 限流间隔的时间单位\n     */")]),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"void"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"setRate"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token class-name"},"RateType"),(0,t.Uk)(" mode"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(" rate"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(" rateInterval"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RateIntervalUnit"),(0,t.Uk)(" rateIntervalUnit"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n    "),(0,t.Wm)("span",{class:"token doc-comment comment"},[(0,t.Uk)("/**\n     * 尝试获取一个许可（permit）\n     *\n     * "),(0,t.Wm)("span",{class:"token tag"},[(0,t.Wm)("span",{class:"token tag"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Uk)("p")]),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Uk)("仅当当前存在可用许可时，取得一个许可并使可用许可数减一，然后返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"true")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n     *\n     * "),(0,t.Wm)("span",{class:"token tag"},[(0,t.Wm)("span",{class:"token tag"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Uk)("p")]),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Uk)("若当前无可用许可则立即返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"false")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n     *\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@return"),(0,t.Uk)(" 若成功取得许可则返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"true")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("，否则返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"false")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n     */")]),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"boolean"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"tryAcquire"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n    "),(0,t.Wm)("span",{class:"token doc-comment comment"},[(0,t.Uk)("/**\n     * 尝试获取指定数量的许可\n     *\n     * "),(0,t.Wm)("span",{class:"token tag"},[(0,t.Wm)("span",{class:"token tag"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Uk)("p")]),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Uk)("仅当当前存在足够数量的可用许可时，取得指定数量的许可并使可用许可数相应减少，然后返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"true")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n     *\n     * "),(0,t.Wm)("span",{class:"token tag"},[(0,t.Wm)("span",{class:"token tag"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Uk)("p")]),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Uk)("若当前不存在足够数量的可用许可则立即返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"false")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n     *\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@param"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token parameter"},"permits"),(0,t.Uk)(" 欲取得的许可数\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@return"),(0,t.Uk)(" 若成功取得指定数量的许可则返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"true")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("，否则返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"false")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n     */")]),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"boolean"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"tryAcquire"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"permits"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n    "),(0,t.Wm)("span",{class:"token doc-comment comment"},"/**\n     * 阻塞地获取一个许可并使可用许可数减一\n     */"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"void"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"acquire"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n    "),(0,t.Wm)("span",{class:"token doc-comment comment"},[(0,t.Uk)("/**\n     * 阻塞地获取指定数量的许可并使可用许可数相应减少\n     *\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@param"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token parameter"},"permits"),(0,t.Uk)(" 欲取得的许可数\n     */")]),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"void"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"acquire"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"permits"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n    "),(0,t.Wm)("span",{class:"token doc-comment comment"},[(0,t.Uk)("/**\n     * 尝试在指定时间内获取一个许可\n     *\n     * "),(0,t.Wm)("span",{class:"token tag"},[(0,t.Wm)("span",{class:"token tag"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Uk)("p")]),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Uk)("在指定时间内，若产生了可用的许可，则取得一个许可并使可用许可数减一，然后返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"true")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("；\n     * 若直到指定时间结束，仍未能取得许可，则返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"false")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("；若指定时间不大于0，不等待\n     *\n     * "),(0,t.Wm)("span",{class:"token tag"},[(0,t.Wm)("span",{class:"token tag"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Uk)("p")]),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Uk)("当确定无法取得许可时，当前线程将进入休眠，无法被调度，直到指定的时间过去\n     *\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@param"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token parameter"},"timeout"),(0,t.Uk)(" 最大等待时间\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@param"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token parameter"},"unit"),(0,t.Uk)("    最大等待时间 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},"timeout")]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)(" 的单位\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@return"),(0,t.Uk)(" 若成功取得许可则返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"true")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("，否则返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"false")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n     */")]),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"boolean"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"tryAcquire"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(" timeout"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"TimeUnit"),(0,t.Uk)(" unit"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n    "),(0,t.Wm)("span",{class:"token doc-comment comment"},[(0,t.Uk)("/**\n     * 尝试在指定时间内获取指定数量的许可\n     *\n     * "),(0,t.Wm)("span",{class:"token tag"},[(0,t.Wm)("span",{class:"token tag"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Uk)("p")]),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Uk)("在指定时间内，若产生了足够多的可用许可，则取得指定数量的许可并使可用许可数相应减少，然后返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"true")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("；\n     * 若直到指定时间结束，仍未能取得指定数量的许可，则返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"false")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("；若指定时间不大于0，不等待\n     *\n     * "),(0,t.Wm)("span",{class:"token tag"},[(0,t.Wm)("span",{class:"token tag"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Uk)("p")]),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Uk)("当确定无法取得许可时，当前线程将进入休眠，无法被调度，直到指定的时间过去\n     *\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@param"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token parameter"},"permits"),(0,t.Uk)(" 欲取得的许可数\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@param"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token parameter"},"timeout"),(0,t.Uk)(" 最大等待时间\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@param"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token parameter"},"unit"),(0,t.Uk)("    最大等待时间 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},"timeout")]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)(" 的单位\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@return"),(0,t.Uk)(" 若成功取得许可则返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"true")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("，否则返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"false")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n     */")]),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"boolean"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"tryAcquire"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"permits"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(" timeout"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"TimeUnit"),(0,t.Uk)(" unit"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n    "),(0,t.Wm)("span",{class:"token doc-comment comment"},[(0,t.Uk)("/**\n     * 获取限流器配置\n     *\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@return"),(0,t.Uk)(" 限流器配置\n     */")]),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token class-name"},"RateLimiterConfig"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"getConfig"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n    "),(0,t.Wm)("span",{class:"token doc-comment comment"},[(0,t.Uk)("/**\n     * 获取可用许可数\n     *\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@return"),(0,t.Uk)(" 可用许可数\n     */")]),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"availablePermits"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t.Wm)("div",{class:"line-numbers"},[(0,t.Wm)("span",{class:"line-number"},"1"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"2"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"3"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"4"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"5"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"6"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"7"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"8"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"9"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"10"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"11"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"12"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"13"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"14"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"15"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"16"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"17"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"18"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"19"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"20"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"21"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"22"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"23"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"24"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"25"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"26"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"27"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"28"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"29"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"30"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"31"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"32"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"33"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"34"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"35"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"36"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"37"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"38"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"39"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"40"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"41"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"42"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"43"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"44"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"45"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"46"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"47"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"48"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"49"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"50"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"51"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"52"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"53"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"54"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"55"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"56"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"57"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"58"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"59"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"60"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"61"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"62"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"63"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"64"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"65"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"66"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"67"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"68"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"69"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"70"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"71"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"72"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"73"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"74"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"75"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"76"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"77"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"78"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"79"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"80"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"81"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"82"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"83"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"84"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"85"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"86"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"87"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"88"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"89"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"90"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"91"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"92"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"93"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"94"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"95"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"96"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"97"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"98"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"99"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"100"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"101"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"102"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"103"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"104"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"105"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"106"),(0,t.Wm)("br")])],-1),u=(0,t.Wm)("p",null,[(0,t.Wm)("code",null,"RRateLimiter"),(0,t.Uk)(" 接口中定义的都是同步方法，在父接口 "),(0,t.Wm)("code",null,"RRateLimiterAsync"),(0,t.Uk)(" 中定义了一系列对应的异步方法。不过，作为一个限流器，它的异步方法应该是很少用的。")],-1),W=(0,t.Wm)("p",null,[(0,t.Wm)("code",null,"RRateLimiter"),(0,t.Uk)(" 提供了允许阻塞等待的 "),(0,t.Wm)("code",null,"acquire"),(0,t.Uk)(" 方法，我们可以以是否取得许可来判断是否需要限流。")],-1),i=(0,t.Wm)("p",null,"写一个 DEMO 跑下看看：",-1),r=(0,t.Wm)("div",{class:"language-java ext-java line-numbers-mode"},[(0,t.Wm)("pre",{class:"language-java"},[(0,t.Wm)("code",null,[(0,t.Wm)("span",{class:"token keyword"},"public"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"class"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RateLimiterTest"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"extends"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"BaseTest"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"private"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"static"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"final"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"String"),(0,t.Uk)(" KEY_NAME "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},'"testRateLimiter"'),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n    "),(0,t.Wm)("span",{class:"token annotation punctuation"},"@Test"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"void"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"testRateLimiter"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"throws"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"InterruptedException"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        redissonClient"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"getRateLimiter"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("KEY_NAME"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"trySetRate"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token class-name"},"RateType"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("OVERALL"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"3"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RateIntervalUnit"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("SECONDS"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token class-name"},"RAtomicLong"),(0,t.Uk)(" total "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" redissonClient"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"getAtomicLong"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},'"testAtomicLong"'),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        total"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"set"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token number"},"0"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n        "),(0,t.Wm)("span",{class:"token class-name"},"List"),(0,t.Wm)("span",{class:"token generics"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Wm)("span",{class:"token class-name"},"Thread"),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Uk)(" threads "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"new"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"LinkedList"),(0,t.Wm)("span",{class:"token generics"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token keyword"},"for"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token keyword"},"int"),(0,t.Uk)(" i "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"0"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)(" i "),(0,t.Wm)("span",{class:"token operator"},"<"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"4"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)(" i"),(0,t.Wm)("span",{class:"token operator"},"++"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n            "),(0,t.Wm)("span",{class:"token class-name"},"String"),(0,t.Uk)(" threadName "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},'"T"'),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"+"),(0,t.Uk)(" i"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n            threads"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"add"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token keyword"},"new"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"Thread"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"->"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n                "),(0,t.Wm)("span",{class:"token class-name"},"RRateLimiter"),(0,t.Uk)(" rateLimiter "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" redissonClient"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"getRateLimiter"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("KEY_NAME"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n                "),(0,t.Wm)("span",{class:"token keyword"},"while"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("total"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"get"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"<"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"30"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n                    rateLimiter"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"acquire"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n                    "),(0,t.Wm)("span",{class:"token class-name"},"System"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("out"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"println"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token class-name"},"String"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"format"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},'"%s - %s拿到许可"'),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"LocalDateTime"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"now"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" threadName"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n                    "),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("total"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"get"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"<"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"30"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n                        total"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"incrementAndGet"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n                    "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n                "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n            "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" threadName"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n\n        threads"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"forEach"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token class-name"},"Thread"),(0,t.Wm)("span",{class:"token operator"},"::"),(0,t.Wm)("span",{class:"token function"},"start"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token keyword"},"for"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token class-name"},"Thread"),(0,t.Uk)(" thread "),(0,t.Wm)("span",{class:"token operator"},":"),(0,t.Uk)(" threads"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n            thread"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"join"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t.Wm)("div",{class:"line-numbers"},[(0,t.Wm)("span",{class:"line-number"},"1"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"2"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"3"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"4"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"5"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"6"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"7"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"8"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"9"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"10"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"11"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"12"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"13"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"14"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"15"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"16"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"17"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"18"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"19"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"20"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"21"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"22"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"23"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"24"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"25"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"26"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"27"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"28"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"29"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"30"),(0,t.Wm)("br")])],-1),U=(0,t.Wm)("p",null,"运行后控制台的打印结果如下：",-1),b=(0,t.Wm)("div",{class:"language-text ext-text line-numbers-mode"},[(0,t.Wm)("pre",{class:"language-text"},[(0,t.Wm)("code",null,"2021-06-02T17:29:58.912 - T2拿到许可\n2021-06-02T17:29:58.914 - T0拿到许可\n2021-06-02T17:29:58.922 - T3拿到许可\n2021-06-02T17:29:59.908 - T0拿到许可\n2021-06-02T17:29:59.908 - T3拿到许可\n2021-06-02T17:29:59.919 - T3拿到许可\n2021-06-02T17:30:00.906 - T3拿到许可\n2021-06-02T17:30:00.906 - T0拿到许可\n2021-06-02T17:30:00.916 - T2拿到许可\n2021-06-02T17:30:01.907 - T2拿到许可\n2021-06-02T17:30:01.908 - T0拿到许可\n2021-06-02T17:30:01.918 - T2拿到许可\n2021-06-02T17:30:02.909 - T3拿到许可\n2021-06-02T17:30:02.909 - T1拿到许可\n2021-06-02T17:30:02.920 - T2拿到许可\n2021-06-02T17:30:03.910 - T0拿到许可\n2021-06-02T17:30:03.912 - T3拿到许可\n2021-06-02T17:30:03.922 - T3拿到许可\n2021-06-02T17:30:04.912 - T1拿到许可\n2021-06-02T17:30:04.912 - T0拿到许可\n2021-06-02T17:30:04.923 - T1拿到许可\n2021-06-02T17:30:05.914 - T3拿到许可\n2021-06-02T17:30:05.914 - T2拿到许可\n2021-06-02T17:30:05.924 - T2拿到许可\n2021-06-02T17:30:06.917 - T0拿到许可\n2021-06-02T17:30:06.917 - T1拿到许可\n2021-06-02T17:30:06.927 - T0拿到许可\n2021-06-02T17:30:07.919 - T3拿到许可\n2021-06-02T17:30:07.920 - T2拿到许可\n2021-06-02T17:30:07.927 - T2拿到许可\n2021-06-02T17:30:08.921 - T1拿到许可\n2021-06-02T17:30:08.921 - T3拿到许可\n2021-06-02T17:30:08.931 - T0拿到许可\n")]),(0,t.Wm)("div",{class:"line-numbers"},[(0,t.Wm)("span",{class:"line-number"},"1"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"2"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"3"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"4"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"5"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"6"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"7"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"8"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"9"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"10"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"11"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"12"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"13"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"14"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"15"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"16"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"17"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"18"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"19"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"20"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"21"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"22"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"23"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"24"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"25"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"26"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"27"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"28"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"29"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"30"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"31"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"32"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"33"),(0,t.Wm)("br")])],-1),d=(0,t.Wm)("p",null,"从打印结果可以看到限流器成功地起到了限流作用，并且可以看到它是基于滑动窗口工作的（拿到许可的时间不是在整秒）。",-1),g=(0,t.Wm)("p",null,"运行后 redis 中多了 4 个键：",-1),y=(0,t.Wm)("p",null,[(0,t.Wm)("img",{src:"data:image/png;base64,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",alt:""})],-1),w=(0,t.Wm)("p",null,[(0,t.Uk)("除了 "),(0,t.Wm)("code",null,"testAtomicLong"),(0,t.Uk)(" 以外，其它 3 个都是限流器相关的。")],-1),f=(0,t.Wm)("p",null,[(0,t.Wm)("code",null,"testRateLimiter"),(0,t.Uk)(" 是一个 Hash（实际上对应 "),(0,t.Wm)("code",null,"RateLimiterConfig"),(0,t.Uk)(" 类）：")],-1),R=(0,t.Wm)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t.Wm)("pre",{class:"language-javascript"},[(0,t.Wm)("code",null,[(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    rate"),(0,t.Wm)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"3"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)("\n    interval"),(0,t.Wm)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"1000"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)("\n    type"),(0,t.Wm)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"0"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t.Wm)("div",{class:"line-numbers"},[(0,t.Wm)("span",{class:"line-number"},"1"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"2"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"3"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"4"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"5"),(0,t.Wm)("br")])],-1),v=(0,t.Wm)("p",null,[(0,t.Wm)("code",null,"{testRateLimiter}:value"),(0,t.Uk)(" 的值是一个整数，这实际上就是当前可用许可数（把限流器改成分钟级并给各线程加上休眠，可以很清晰地观察到）。")],-1),A=(0,t.Wm)("p",null,[(0,t.Wm)("code",null,"{testRateLimiter}:permits"),(0,t.Uk)(" 是一个 ZSet：")],-1),T=(0,t.Wm)("div",{class:"language-javascript ext-js line-numbers-mode"},[(0,t.Wm)("pre",{class:"language-javascript"},[(0,t.Wm)("code",null,[(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token template-string"},[(0,t.Wm)("span",{class:"token template-punctuation string"},"`"),(0,t.Wm)("span",{class:"token string"},"c\\\\xac\\\\xb4^\\\\x1\\\\x0\\\\x0\\\\x0"),(0,t.Wm)("span",{class:"token template-punctuation string"},"`")]),(0,t.Wm)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"1622626208929"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token template-string"},[(0,t.Wm)("span",{class:"token template-punctuation string"},"`"),(0,t.Wm)("span",{class:"token string"},"\\\\xf1#\\\\xce^\\\\x1\\\\x0\\\\x0\\\\x0"),(0,t.Wm)("span",{class:"token template-punctuation string"},"`")]),(0,t.Wm)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"1622626208920"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token template-string"},[(0,t.Wm)("span",{class:"token template-punctuation string"},"`"),(0,t.Wm)("span",{class:"token string"},"H\\\\xaa\\\\xa8\\\\xdd\\\\x1\\\\x0\\\\x0\\\\x0"),(0,t.Wm)("span",{class:"token template-punctuation string"},"`")]),(0,t.Wm)("span",{class:"token operator"},":"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"1622626208920"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t.Wm)("div",{class:"line-numbers"},[(0,t.Wm)("span",{class:"line-number"},"1"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"2"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"3"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"4"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"5"),(0,t.Wm)("br")])],-1),h=(0,t.Wm)("p",null,[(0,t.Uk)("排序值是上一次取得许可的时间，元素则看起来是某种二进制序列化编码，应该对应着线程中的 "),(0,t.Wm)("code",null,"RRateLimiter"),(0,t.Uk)(" 对象，也可能是某种有防碰撞能力的随机值。也就是说，这个 ZSet 是许可发放记录。")],-1),E=(0,t.Wm)("blockquote",null,[(0,t.Wm)("p",null,[(0,t.Uk)("看到这个 ZSet 之后基本上就能猜到 "),(0,t.Wm)("code",null,"RRateLimiter"),(0,t.Uk)(" 的大致限流原理了：用当前时间戳与 ZSet 中最早的一个时间戳作差，比较时间差是否大于 "),(0,t.Wm)("code",null,"interval"),(0,t.Uk)("，若大于则发放许可，否则进行限制。")])],-1),N=(0,t.Wm)("p",null,"记录下代码运行的现象后，接下来就该研究实现类的源码了。",-1),L=(0,t.Wm)("h2",{id:"redissonratelimiter-源码阅读",tabindex:"-1"},[(0,t.Wm)("a",{class:"header-anchor",href:"#redissonratelimiter-源码阅读","aria-hidden":"true"},"#"),(0,t.Uk)(),(0,t.Wm)("code",null,"RedissonRateLimiter"),(0,t.Uk)(" 源码阅读")],-1),S=(0,t.Wm)("p",null,[(0,t.Wm)("code",null,"RRateLimiter"),(0,t.Uk)(" 接口只有一个实现类 "),(0,t.Wm)("code",null,"RedissonRateLimiter"),(0,t.Uk)("，粗略地速览一眼源码，不难发现同步方法和 "),(0,t.Wm)("code",null,"RedissonBucket"),(0,t.Uk)(" 一样都是在阻塞获取异步方法的 "),(0,t.Wm)("code",null,"Future"),(0,t.Uk)(" 结果。")],-1),C=(0,t.Wm)("p",null,"先来看限流器配置的方法：",-1),x=(0,t.Wm)("div",{class:"language-java ext-java line-numbers-mode"},[(0,t.Wm)("pre",{class:"language-java"},[(0,t.Wm)("code",null,[(0,t.Wm)("span",{class:"token annotation punctuation"},"@Override"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"public"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RFuture"),(0,t.Wm)("span",{class:"token generics"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Wm)("span",{class:"token class-name"},"Boolean"),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"trySetRateAsync"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token class-name"},"RateType"),(0,t.Uk)(" type"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(" rate"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(" rateInterval"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RateIntervalUnit"),(0,t.Uk)(" unit"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token comment"},"// 对三个字段的写入是相互独立的，假如 redis 中已经存在一个键名为 name 的 Hash，并且有一个键名为 type 的元素，trySetRateAsync 方法仍然会写入另外两个字段"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"return"),(0,t.Uk)(" commandExecutor"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"evalWriteAsync"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token function"},"getRawName"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"LongCodec"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("INSTANCE"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RedisCommands"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("EVAL_BOOLEAN"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)("\n            "),(0,t.Wm)("span",{class:"token string"},"\"redis.call('hsetnx', KEYS[1], 'rate', ARGV[1]);\""),(0,t.Uk)("\n          "),(0,t.Wm)("span",{class:"token operator"},"+"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"\"redis.call('hsetnx', KEYS[1], 'interval', ARGV[2]);\""),(0,t.Uk)("\n          "),(0,t.Wm)("span",{class:"token operator"},"+"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"\"return redis.call('hsetnx', KEYS[1], 'type', ARGV[3]);\""),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)("\n            "),(0,t.Wm)("span",{class:"token class-name"},"Collections"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"singletonList"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token function"},"getRawName"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" rate"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" unit"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"toMillis"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("rateInterval"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" type"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"ordinal"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n\n"),(0,t.Wm)("span",{class:"token annotation punctuation"},"@Override"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"public"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RFuture"),(0,t.Wm)("span",{class:"token generics"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Wm)("span",{class:"token class-name"},"Void"),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"setRateAsync"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token class-name"},"RateType"),(0,t.Uk)(" type"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(" rate"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(" rateInterval"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RateIntervalUnit"),(0,t.Uk)(" unit"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n     "),(0,t.Wm)("span",{class:"token keyword"},"return"),(0,t.Uk)(" commandExecutor"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"evalWriteAsync"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token function"},"getRawName"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"LongCodec"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("INSTANCE"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RedisCommands"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("EVAL_BOOLEAN"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)("\n            "),(0,t.Wm)("span",{class:"token string"},"\"redis.call('hset', KEYS[1], 'rate', ARGV[1]);\""),(0,t.Uk)("\n                    "),(0,t.Wm)("span",{class:"token operator"},"+"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"\"redis.call('hset', KEYS[1], 'interval', ARGV[2]);\""),(0,t.Uk)("\n                    "),(0,t.Wm)("span",{class:"token operator"},"+"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"\"redis.call('hset', KEYS[1], 'type', ARGV[3]);\""),(0,t.Uk)("\n                    "),(0,t.Wm)("span",{class:"token operator"},"+"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"\"redis.call('del', KEYS[2], KEYS[3]);\""),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)("\n            "),(0,t.Wm)("span",{class:"token class-name"},"Arrays"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"asList"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token function"},"getRawName"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"getValueName"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"getPermitsName"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" rate"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" unit"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"toMillis"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("rateInterval"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" type"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"ordinal"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t.Wm)("div",{class:"line-numbers"},[(0,t.Wm)("span",{class:"line-number"},"1"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"2"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"3"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"4"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"5"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"6"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"7"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"8"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"9"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"10"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"11"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"12"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"13"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"14"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"15"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"16"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"17"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"18"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"19"),(0,t.Wm)("br")])],-1),I=(0,t.Wm)("p",null,[(0,t.Uk)("显然，"),(0,t.Wm)("code",null,"setRateAsync"),(0,t.Uk)(" 做的事情就是往 redis 中以 Hash 的形式放置一个 "),(0,t.Wm)("code",null,"RateLimiterConfig"),(0,t.Uk)(" 对象，而 "),(0,t.Wm)("code",null,"trySetRateAsync"),(0,t.Uk)(" 则只会在 Hash 的值未存在时才写入。")],-1),j=(0,t.Wm)("blockquote",null,[(0,t.Wm)("p",null,"相比 String 结构，使用 Hash 结构更便于 Lua 脚本分别读写限流器配置的各个属性，也避免了对象序列化的问题。")],-1),G=(0,t.Wm)("p",null,"再看获取当前可用许可数量的方法：",-1),q=(0,t.Wm)("div",{class:"language-java ext-java line-numbers-mode"},[(0,t.Wm)("pre",{class:"language-java"},[(0,t.Wm)("code",null,[(0,t.Wm)("span",{class:"token annotation punctuation"},"@Override"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"public"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"availablePermits"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"return"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"get"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token function"},"availablePermitsAsync"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n\n"),(0,t.Wm)("span",{class:"token annotation punctuation"},"@Override"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"public"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RFuture"),(0,t.Wm)("span",{class:"token generics"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Wm)("span",{class:"token class-name"},"Long"),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"availablePermitsAsync"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"return"),(0,t.Uk)(" commandExecutor"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"evalWriteAsync"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token function"},"getRawName"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"LongCodec"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("INSTANCE"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RedisCommands"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("EVAL_LONG"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)("\n            "),(0,t.Wm)("span",{class:"token string"},'"……Lua脚本……"'),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)("\n            "),(0,t.Wm)("span",{class:"token class-name"},"Arrays"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"asList"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token function"},"getRawName"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"getValueName"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"getClientValueName"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"getPermitsName"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"getClientPermitsName"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)("\n            "),(0,t.Wm)("span",{class:"token class-name"},"System"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"currentTimeMillis"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t.Wm)("div",{class:"line-numbers"},[(0,t.Wm)("span",{class:"line-number"},"1"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"2"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"3"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"4"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"5"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"6"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"7"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"8"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"9"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"10"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"11"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"12"),(0,t.Wm)("br")])],-1),V=(0,t.Wm)("p",null,[(0,t.Wm)("code",null,"availablePermitsAsync"),(0,t.Uk)(" 方法的 Lua 脚本需要传入 5 个 KEY 和 1 个 ARGV。打上断点执行 "),(0,t.Wm)("code",null,"availablePermits"),(0,t.Uk)(" 方法，可以看到某次执行中 5 个 KEY 分别是 "),(0,t.Wm)("code",null,"testRateLimiter"),(0,t.Uk)("、"),(0,t.Wm)("code",null,"{testRateLimiter}:value"),(0,t.Uk)("、"),(0,t.Wm)("code",null,"{testRateLimiter}:value:6f9aa4f9-454d-4d68-b8fc-ce4350527251"),(0,t.Uk)("、"),(0,t.Wm)("code",null,"{testRateLimiter}:permits"),(0,t.Uk)(" 和 "),(0,t.Wm)("code",null,"{testRateLimiter}:permits:6f9aa4f9-454d-4d68-b8fc-ce4350527251"),(0,t.Uk)("，ARGV 则为 13 位时间戳。")],-1),K=(0,t.Wm)("p",null,[(0,t.Uk)("其中，"),(0,t.Wm)("code",null,"6f9aa4f9-454d-4d68-b8fc-ce4350527251"),(0,t.Uk)(" 是通过 "),(0,t.Wm)("code",null,"commandExecutor.getConnectionManager().getId()"),(0,t.Uk)(" 得到的，这是一个 UUID。每一个 "),(0,t.Wm)("code",null,"RedissonClient"),(0,t.Uk)(" 都拥有一个 ID，通过同一个 "),(0,t.Wm)("code",null,"RedissonClient"),(0,t.Uk)(" 对象创建的各种 Redisson 数据结构和分布式锁都共享该 ID。")],-1),M=(0,t.Wm)("blockquote",null,[(0,t.Wm)("p",null,[(0,t.Uk)("这个 UUID 是在创建 "),(0,t.Wm)("code",null,"ConnectionManager"),(0,t.Uk)(" 实例时随机生成的，见 "),(0,t.Wm)("code",null,"ConfigSupport"),(0,t.Uk)(" 类源码。。")])],-1),Y=(0,t.Wm)("p",null,[(0,t.Wm)("code",null,"availablePermitsAsync"),(0,t.Uk)(" 方法中的 Lua 脚本如下：")],-1),F=(0,t.Wm)("div",{class:"language-lua ext-lua line-numbers-mode"},[(0,t.Wm)("pre",{class:"language-lua"},[(0,t.Wm)("code",null,[(0,t.Wm)("span",{class:"token comment"},"-- 获取限流器配置"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"local"),(0,t.Uk)(" rate "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" redis"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'hget'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" KEYS"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'rate'"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"local"),(0,t.Uk)(" interval "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" redis"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'hget'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" KEYS"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'interval'"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"local"),(0,t.Uk)(" type "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" redis"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'hget'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" KEYS"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'type'"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token function"},"assert"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("rate "),(0,t.Wm)("span",{class:"token operator"},"~="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"false"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"and"),(0,t.Uk)(" interval "),(0,t.Wm)("span",{class:"token operator"},"~="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"false"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"and"),(0,t.Uk)(" type "),(0,t.Wm)("span",{class:"token operator"},"~="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"false"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'RateLimiter is not initialized'"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n\n"),(0,t.Wm)("span",{class:"token comment"},"-- 读取键名；单节点限流时使用带UUID的键名，多节点限流则使用不带UUID的"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"local"),(0,t.Uk)(" valueName "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" KEYS"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"2"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"local"),(0,t.Uk)(" permitsName "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" KEYS"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"4"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(" type "),(0,t.Wm)("span",{class:"token operator"},"=="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'1'"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"then"),(0,t.Uk)("\n  valueName "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" KEYS"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"3"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n  permitsName "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" KEYS"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"5"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"end"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n"),(0,t.Wm)("span",{class:"token comment"},"-- 读取当前可用许可数"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"local"),(0,t.Uk)(" currentValue "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" redis"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'get'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" valueName"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(" currentValue "),(0,t.Wm)("span",{class:"token operator"},"=="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"false"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"then"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token comment"},"-- 键未存在时说明限流器还没有开始起作用，初始化放入满数量的许可"),(0,t.Uk)("\n    redis"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'set'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" valueName"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" rate"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"return"),(0,t.Uk)(" rate"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"else"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token comment"},"-- 在许可发放记录中，早于当前时间减限流间隔的，都是已经过期的记录"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"local"),(0,t.Uk)(" expiredValues "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" redis"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'zrangebyscore'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" permitsName"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"0"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"tonumber"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("ARGV"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"-"),(0,t.Uk)(" interval"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token comment"},"-- 这个变量用来记录待释放许可数"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"local"),(0,t.Uk)(" released "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"0"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token comment"},"-- 遍历过期的记录，回收许可"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"for"),(0,t.Uk)(" i"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" v "),(0,t.Wm)("span",{class:"token keyword"},"in"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"ipairs"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("expiredValues"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"do"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token keyword"},"local"),(0,t.Uk)(" random"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" permits "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" struct"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"unpack"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'fI'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" v"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        released "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" released "),(0,t.Wm)("span",{class:"token operator"},"+"),(0,t.Uk)(" permits"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"end"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n    "),(0,t.Wm)("span",{class:"token comment"},"-- 如果需要释放的许可大于0，删除过期记录，并将释放的记录数加到结果上，然后更新当前可用许可数"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(" released "),(0,t.Wm)("span",{class:"token operator"},">"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"0"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"then"),(0,t.Uk)("\n        redis"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'zremrangebyscore'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" permitsName"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"0"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"tonumber"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("ARGV"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"-"),(0,t.Uk)(" interval"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        currentValue "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"tonumber"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("currentValue"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"+"),(0,t.Uk)(" released"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        redis"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'set'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" valueName"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" currentValue"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"end"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n    "),(0,t.Wm)("span",{class:"token keyword"},"return"),(0,t.Uk)(" currentValue"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"end"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n")])]),(0,t.Wm)("div",{class:"line-numbers"},[(0,t.Wm)("span",{class:"line-number"},"1"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"2"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"3"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"4"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"5"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"6"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"7"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"8"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"9"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"10"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"11"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"12"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"13"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"14"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"15"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"16"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"17"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"18"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"19"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"20"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"21"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"22"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"23"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"24"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"25"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"26"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"27"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"28"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"29"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"30"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"31"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"32"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"33"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"34"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"35"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"36"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"37"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"38"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"39"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"40"),(0,t.Wm)("br")])],-1),O=(0,t.Wm)("p",null,"可以看到，脚本中对当前可用许可数以及许可发放记录进行了懒更新。",-1),z=(0,t.Wm)("p",null,[(0,t.Uk)("最后看一下获取许可的方法是如何实现的。"),(0,t.Wm)("code",null,"RedissonRateLimiter"),(0,t.Uk)(" 中有多个 "),(0,t.Wm)("code",null,"tryAcquireAsync"),(0,t.Uk)(" 方法，其中 "),(0,t.Wm)("code",null,"private <T> RFuture<T> tryAcquireAsync(RedisCommand<T> command, Long value)"),(0,t.Uk)(" 会被其它所有重载方法调用，其代码如下：")],-1),B=(0,t.Wm)("div",{class:"language-java ext-java line-numbers-mode"},[(0,t.Wm)("pre",{class:"language-java"},[(0,t.Wm)("code",null,[(0,t.Wm)("span",{class:"token keyword"},"private"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token generics"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Wm)("span",{class:"token class-name"},"T"),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RFuture"),(0,t.Wm)("span",{class:"token generics"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Wm)("span",{class:"token class-name"},"T"),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"tryAcquireAsync"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token class-name"},"RedisCommand"),(0,t.Wm)("span",{class:"token generics"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Wm)("span",{class:"token class-name"},"T"),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Uk)(" command"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"Long"),(0,t.Uk)(" value"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token keyword"},"return"),(0,t.Uk)(" commandExecutor"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"evalWriteAsync"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token function"},"getRawName"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"LongCodec"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("INSTANCE"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" command"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)("\n                "),(0,t.Wm)("span",{class:"token string"},'"……Lua脚本……"'),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)("\n                "),(0,t.Wm)("span",{class:"token comment"},"// 还是那 5 个 KEY"),(0,t.Uk)("\n                "),(0,t.Wm)("span",{class:"token class-name"},"Arrays"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"asList"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token function"},"getRawName"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"getValueName"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"getClientValueName"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"getPermitsName"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"getClientPermitsName"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)("\n                "),(0,t.Wm)("span",{class:"token comment"},"// 3 个入参分别是申请的许可数、当前时间、随机整数"),(0,t.Uk)("\n                value"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"System"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"currentTimeMillis"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"ThreadLocalRandom"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"current"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"nextLong"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t.Wm)("div",{class:"line-numbers"},[(0,t.Wm)("span",{class:"line-number"},"1"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"2"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"3"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"4"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"5"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"6"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"7"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"8"),(0,t.Wm)("br")])],-1),X=(0,t.Wm)("p",null,[(0,t.Uk)("其它重载方法传入的 "),(0,t.Wm)("code",null,"command"),(0,t.Uk)(" 参数是 "),(0,t.Wm)("code",null,"EVAL_NULL_BOOLEAN"),(0,t.Uk)(" 或 "),(0,t.Wm)("code",null,"EVAL_LONG"),(0,t.Uk)("，都是执行 "),(0,t.Wm)("code",null,"eval"),(0,t.Uk)(" 命令，只是返回值类型不同。")],-1),D=(0,t.Wm)("p",null,"方法中的 Lua 脚本如下：",-1),P=(0,t.Wm)("div",{class:"language-lua ext-lua line-numbers-mode"},[(0,t.Wm)("pre",{class:"language-lua"},[(0,t.Wm)("code",null,[(0,t.Wm)("span",{class:"token comment"},"-- 获取限流器配置"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"local"),(0,t.Uk)(" rate "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" redis"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'hget'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" KEYS"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'rate'"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"local"),(0,t.Uk)(" interval "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" redis"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'hget'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" KEYS"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'interval'"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"local"),(0,t.Uk)(" type "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" redis"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'hget'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" KEYS"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'type'"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token function"},"assert"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("rate "),(0,t.Wm)("span",{class:"token operator"},"~="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"false"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"and"),(0,t.Uk)(" interval "),(0,t.Wm)("span",{class:"token operator"},"~="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"false"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"and"),(0,t.Uk)(" type "),(0,t.Wm)("span",{class:"token operator"},"~="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"false"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'RateLimiter is not initialized'"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)("\n\n"),(0,t.Wm)("span",{class:"token comment"},"-- 读取键名；单节点限流时使用带UUID的键名，多节点限流则使用不带UUID的"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"local"),(0,t.Uk)(" valueName "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" KEYS"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"2"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"local"),(0,t.Uk)(" permitsName "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" KEYS"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"4"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(" type "),(0,t.Wm)("span",{class:"token operator"},"=="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'1'"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"then"),(0,t.Uk)("\n    valueName "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" KEYS"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"3"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    permitsName "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" KEYS"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"5"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"end"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n"),(0,t.Wm)("span",{class:"token comment"},"-- 校验申请许可数的合法性（不能大于限流阈值）"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token function"},"assert"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token function"},"tonumber"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("rate"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},">="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"tonumber"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("ARGV"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'Requested permits amount could not exceed defined rate'"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n"),(0,t.Wm)("span",{class:"token comment"},"-- 读取当前可用许可数"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"local"),(0,t.Uk)(" currentValue "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" redis"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'get'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" valueName"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(" currentValue "),(0,t.Wm)("span",{class:"token operator"},"~="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"false"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"then"),(0,t.Uk)("\n\n    "),(0,t.Wm)("span",{class:"token comment"},"-- 下面两小段是清理过期的许可发放记录，并回收到可用许可数上，和availablePermitsAsync方法的脚本是一样的"),(0,t.Uk)("\n\n    "),(0,t.Wm)("span",{class:"token keyword"},"local"),(0,t.Uk)(" expiredValues "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" redis"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'zrangebyscore'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" permitsName"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"0"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"tonumber"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("ARGV"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"2"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"-"),(0,t.Uk)(" interval"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"local"),(0,t.Uk)(" released "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"0"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"for"),(0,t.Uk)(" i"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" v "),(0,t.Wm)("span",{class:"token keyword"},"in"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"ipairs"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("expiredValues"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"do"),(0,t.Uk)("\n         "),(0,t.Wm)("span",{class:"token keyword"},"local"),(0,t.Uk)(" random"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" permits "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" struct"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"unpack"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'fI'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" v"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n         released "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" released "),(0,t.Wm)("span",{class:"token operator"},"+"),(0,t.Uk)(" permits"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"end"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n    "),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(" released "),(0,t.Wm)("span",{class:"token operator"},">"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"0"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"then"),(0,t.Uk)("\n         redis"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'zremrangebyscore'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" permitsName"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"0"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"tonumber"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("ARGV"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"2"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"-"),(0,t.Uk)(" interval"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n         currentValue "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"tonumber"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("currentValue"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"+"),(0,t.Uk)(" released"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n         redis"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'set'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" valueName"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" currentValue"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"end"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n    "),(0,t.Wm)("span",{class:"token comment"},"-- 判断当前许可数是否满足申请需求（若小于则不满足）"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"tonumber"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("currentValue"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"<"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"tonumber"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("ARGV"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"then"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token comment"},"-- 获取当前限流窗口内已经发放的许可记录的第一条（最早的那条）"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token keyword"},"local"),(0,t.Uk)(" nearest "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" redis"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'zrangebyscore'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" permitsName"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'('"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},".."),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token function"},"tonumber"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("ARGV"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"2"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"-"),(0,t.Uk)(" interval"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'+inf'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'withscores'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},"'limit'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"0"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token comment"},"-- 返回值的含义是多久后可以再次尝试（或者说，多长时间内不要再尝试）"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token keyword"},"return"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"tonumber"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("nearest"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"2"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"-"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token function"},"tonumber"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("ARGV"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"2"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"-"),(0,t.Uk)(" interval"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"else"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token comment"},"-- 当前许可数量足够，减少申请的数量，并进行记录"),(0,t.Uk)("\n        redis"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'zadd'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" permitsName"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" ARGV"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"2"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" struct"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"pack"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'fI'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" ARGV"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"3"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" ARGV"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        redis"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'decrby'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" valueName"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" ARGV"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token keyword"},"return"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"nil"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"end"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"else"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token comment"},"-- 键未存在时说明限流器还没有开始起作用，初始化放入满数量的许可；这里没有直接设置成rate-ARGV[1]，而是执行zadd后再decrby，可能是为了避免zadd执行出错（例如突然宕机）导致许可上限出现偏差"),(0,t.Uk)("\n    redis"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'set'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" valueName"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" rate"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token comment"},"-- 增加许可发放记录；KEY 是个 Java 传入的随机数，值是申请的许可数"),(0,t.Uk)("\n    redis"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'zadd'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" permitsName"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" ARGV"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"2"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" struct"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"pack"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'fI'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" ARGV"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"3"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" ARGV"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token comment"},"-- 减去申请的许可数"),(0,t.Uk)("\n    redis"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"call"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},"'decrby'"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" valueName"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" ARGV"),(0,t.Wm)("span",{class:"token punctuation"},"["),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Wm)("span",{class:"token punctuation"},"]"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"return"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"nil"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"end"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n")])]),(0,t.Wm)("div",{class:"line-numbers"},[(0,t.Wm)("span",{class:"line-number"},"1"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"2"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"3"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"4"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"5"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"6"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"7"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"8"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"9"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"10"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"11"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"12"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"13"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"14"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"15"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"16"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"17"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"18"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"19"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"20"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"21"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"22"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"23"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"24"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"25"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"26"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"27"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"28"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"29"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"30"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"31"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"32"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"33"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"34"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"35"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"36"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"37"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"38"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"39"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"40"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"41"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"42"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"43"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"44"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"45"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"46"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"47"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"48"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"49"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"50"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"51"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"52"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"53"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"54"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"55"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"56"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"57"),(0,t.Wm)("br")])],-1),J=(0,t.Wm)("p",null,"源码读到这里，我们不妨先整理一下 Redisson 的限流器设计思路。Redisson 的限流器采用的是滑动窗口算法，一个限流器由配置表、剩余许可计数器、许可发放记录表三个部分组成。",-1),Z=(0,t.Wm)("p",null,[(0,t.Wm)("img",{src:e,alt:"限流器的组成"})],-1),H=(0,t.Wm)("p",null,"限流器的配置是可以动态修改的，所以在执行获取剩余许可数、申请许可等操作时（下文统称“使用限流器”），都需要先读取限流器的最新配置。",-1),Q=(0,t.Wm)("p",null,[(0,t.Uk)("在使用全局限流模式时，所有 JVM 内的全部 "),(0,t.Wm)("code",null,"RedissonClient"),(0,t.Uk)(" 对象共享同一张许可发放记录表，而使用单节点限流模式时，每一个 "),(0,t.Wm)("code",null,"RedissonClient"),(0,t.Uk)(" 对应一张单独的许可发放记录表。")],-1),_=(0,t.Wm)("p",null,"剩余许可计数器和许可发放记录表都是懒更新的，每当我们使用限流器时，都需要根据当前时间对许可发放记录表和剩余许可计数器的状态进行更新。",-1),$=(0,t.Wm)("p",null,[(0,t.Uk)("假设有一全局限流器，其限流阈值为 3，限流窗口为 1000 毫秒，并且许可发放记录表中有 3 条记录 "),(0,t.Wm)("code",null,"[1622626896000, 1622626896100, 1622626896200]"),(0,t.Uk)("。")],-1),nn=(0,t.Wm)("p",null,[(0,t.Uk)("假设某线程在时刻 "),(0,t.Wm)("code",null,"1622626896300"),(0,t.Uk)(" 申请许可，那么当前时间减去限流窗口就是 "),(0,t.Wm)("code",null,"1622626895300"),(0,t.Uk)("，由于记录表中的 3 条记录都在区间 "),(0,t.Wm)("code",null,"(1622626895300,1622626896300)"),(0,t.Uk)(" 之内，就说明 1000 毫秒内已经发放过 3 次许可，所以此时不能继续发放许可，触发限流。")],-1),sn=(0,t.Wm)("p",null,[(0,t.Uk)("之后，假设某线程在时刻 "),(0,t.Wm)("code",null,"1622626897150"),(0,t.Uk)(" 申请许可，那么此时有效限流窗口就是 "),(0,t.Wm)("code",null,"(1622626896150,1622626897150)"),(0,t.Uk)("，此时记录表中只剩下 "),(0,t.Wm)("code",null,"1622626896200"),(0,t.Uk)(" 这一条记录仍处在有效限流窗口内，"),(0,t.Wm)("code",null,"1622626896000"),(0,t.Uk)(" 和 "),(0,t.Wm)("code",null,"1622626896100"),(0,t.Uk)(" 都需要清除，此时记录表就变成 "),(0,t.Wm)("code",null,"[1622626896200]"),(0,t.Uk)("，而剩余许可计数器则应由 "),(0,t.Wm)("code",null,"0"),(0,t.Uk)(" 更新为 "),(0,t.Wm)("code",null,"限流阈值 - 许可发放记录表长度 = 3 - 1 = 2"),(0,t.Uk)("。由于剩余许可计数器大于 0，所以限流器可以对该线程发放许可，然后将当前时间 "),(0,t.Wm)("code",null,"1622626897150"),(0,t.Uk)(" 直接插入到许可发放记录表的后方，并将剩余许可计数器更新为 "),(0,t.Wm)("code",null,"限流阈值 - 许可发放记录表长度 = 3 - 2 = 1"),(0,t.Uk)("。")],-1),an=(0,t.Wm)("p",null,[(0,t.Uk)("之后，假设限流器的限流阈值被修改为 "),(0,t.Wm)("code",null,"2"),(0,t.Uk)("，并且某线程在时刻 "),(0,t.Wm)("code",null,"1622626897190"),(0,t.Uk)(" 申请许可，此时许可发放记录表为 "),(0,t.Wm)("code",null,"[1622626896200, 1622626897150]"),(0,t.Uk)("，两个记录都处在有效窗口 "),(0,t.Wm)("code",null,"(1622626896190,1622626897190)"),(0,t.Uk)(" 之内，此时剩余许可计数器被更新为 "),(0,t.Wm)("code",null,"限流阈值 - 许可发放记录表长度 = 2 - 2 = 0"),(0,t.Uk)("，由于剩余许可计数器的值不大于 0，所以不能对该线程发放许可。")],-1),tn=(0,t.Wm)("p",null,"总之，Redisson 就是借助有序的发放许可记录，来判断限流窗口内的许可发放次数是否达到了设定的阈值，由此帮助我们实现限流功能。",-1),en=(0,t.Wm)("p",null,[(0,t.Uk)("接下来，再看看阻塞等待和超时是如何实现的，对应的重载方法为 "),(0,t.Wm)("code",null,"private void tryAcquireAsync(long permits, RPromise<Boolean> promise, long timeoutInMillis)"),(0,t.Uk)("，这是一个会调用自身的递归方法。")],-1),on=(0,t.Wm)("p",null,[(0,t.Uk)("这个方法在 "),(0,t.Wm)("code",null,"RedissonRateLimiter"),(0,t.Uk)(" 内有三处调用，其中有两处是方法内部的递归调用，还有一处调用在另一个重载方法 "),(0,t.Wm)("code",null,"public RFuture<Boolean> tryAcquireAsync(long permits, long timeout, TimeUnit unit)"),(0,t.Uk)(" 中：")],-1),cn=(0,t.Wm)("div",{class:"language-java ext-java line-numbers-mode"},[(0,t.Wm)("pre",{class:"language-java"},[(0,t.Wm)("code",null,[(0,t.Wm)("span",{class:"token annotation punctuation"},"@Override"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"public"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RFuture"),(0,t.Wm)("span",{class:"token generics"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Wm)("span",{class:"token class-name"},"Boolean"),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"tryAcquireAsync"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"permits"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(" timeout"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"TimeUnit"),(0,t.Uk)(" unit"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token class-name"},"RPromise"),(0,t.Wm)("span",{class:"token generics"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Wm)("span",{class:"token class-name"},"Boolean"),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Uk)(" promise "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"new"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RedissonPromise"),(0,t.Wm)("span",{class:"token generics"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Wm)("span",{class:"token class-name"},"Boolean"),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(" timeoutInMillis "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"-"),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("timeout "),(0,t.Wm)("span",{class:"token operator"},">="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"0"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        timeoutInMillis "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" unit"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"toMillis"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("timeout"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token comment"},"// promise是刚new出来的"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token function"},"tryAcquireAsync"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token keyword"},"permits"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" promise"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" timeoutInMillis"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token comment"},"// 这里返回的是 promise 对象，同步的方法中会调用阻塞获取其结果的方法，只有当 promise 的状态被通过副作用标记为执行完成或出错，才能获取其结果"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"return"),(0,t.Uk)(" promise"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t.Wm)("div",{class:"line-numbers"},[(0,t.Wm)("span",{class:"line-number"},"1"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"2"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"3"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"4"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"5"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"6"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"7"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"8"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"9"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"10"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"11"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"12"),(0,t.Wm)("br")])],-1),mn=(0,t.Wm)("p",null,[(0,t.Uk)("不难推测，"),(0,t.Wm)("code",null,"RedissonRateLimiter"),(0,t.Uk)(" 会通过副作用来修改 "),(0,t.Wm)("code",null,"RPromise"),(0,t.Uk)(" 对象的状态。")],-1),ln=(0,t.Wm)("p",null,[(0,t.Uk)("先读一下 "),(0,t.Wm)("code",null,"RPromise"),(0,t.Uk)(" 接口：")],-1),pn=(0,t.Wm)("div",{class:"language-java ext-java line-numbers-mode"},[(0,t.Wm)("pre",{class:"language-java"},[(0,t.Wm)("code",null,[(0,t.Wm)("span",{class:"token keyword"},"public"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"interface"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RPromise"),(0,t.Wm)("span",{class:"token generics"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Wm)("span",{class:"token class-name"},"T"),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"extends"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RFuture"),(0,t.Wm)("span",{class:"token generics"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Wm)("span",{class:"token class-name"},"T"),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n\n    "),(0,t.Wm)("span",{class:"token doc-comment comment"},[(0,t.Uk)("/**\n     * 标记该 Future 的结果为成功，并唤醒所有监听器\n     *\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@param"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token parameter"},"result"),(0,t.Uk)(" 结果对象\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@return"),(0,t.Uk)(" 当且仅当结果被成功标记时返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"true")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("，否则说明该 Future 的结果已经被标记过，返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"false")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("。\n     */")]),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"boolean"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"trySuccess"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token class-name"},"T"),(0,t.Uk)(" result"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n    "),(0,t.Wm)("span",{class:"token doc-comment comment"},[(0,t.Uk)("/**\n     * 标记该 Future 的结果为出错，并唤醒所有监听器\n     *\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@param"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token parameter"},"cause"),(0,t.Uk)(" 异常\n     * "),(0,t.Wm)("span",{class:"token keyword"},"@return"),(0,t.Uk)(" 当且仅当结果被成功标记时返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"true")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("，否则说明该 Future 的结果已经被标记过，返回 "),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Wm)("span",{class:"token keyword"},"@code"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token code-section"},[(0,t.Wm)("span",{class:"token code language-java"},[(0,t.Wm)("span",{class:"token boolean"},"false")])]),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("。\n     */")]),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"boolean"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"tryFailure"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token class-name"},"Throwable"),(0,t.Uk)(" cause"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n    "),(0,t.Wm)("span",{class:"token comment"},"// ……省略其它方法……"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t.Wm)("div",{class:"line-numbers"},[(0,t.Wm)("span",{class:"line-number"},"1"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"2"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"3"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"4"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"5"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"6"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"7"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"8"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"9"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"10"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"11"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"12"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"13"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"14"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"15"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"16"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"17"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"18"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"19"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"20"),(0,t.Wm)("br")])],-1),kn=(0,t.Wm)("p",null,[(0,t.Uk)("显然，"),(0,t.Wm)("code",null,"RPromise"),(0,t.Uk)(" 就是个传话筒。")],-1),un=(0,t.Wm)("p",null,"接下来就该好好读一下递归方法了：",-1),Wn=(0,t.Wm)("div",{class:"language-java ext-java line-numbers-mode"},[(0,t.Wm)("pre",{class:"language-java"},[(0,t.Wm)("code",null,[(0,t.Wm)("span",{class:"token keyword"},"private"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"void"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"tryAcquireAsync"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"permits"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RPromise"),(0,t.Wm)("span",{class:"token generics"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Wm)("span",{class:"token class-name"},"Boolean"),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Uk)(" promise"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(" timeoutInMillis"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(" s "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"System"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"currentTimeMillis"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token comment"},"// 调用前面分析过的许可申请方法"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token class-name"},"RFuture"),(0,t.Wm)("span",{class:"token generics"},[(0,t.Wm)("span",{class:"token punctuation"},"<"),(0,t.Wm)("span",{class:"token class-name"},"Long"),(0,t.Wm)("span",{class:"token punctuation"},">")]),(0,t.Uk)(" future "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"tryAcquireAsync"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token class-name"},"RedisCommands"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("EVAL_LONG"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"permits"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token comment"},"// 设置结果返回时的行为，这里的 delay 是 Lua 脚本返回的值，其含义为多长时间后可以再次申请许可，e 则为 Throwable 对象"),(0,t.Uk)("\n    future"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"onComplete"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("delay"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" e"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"->"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token comment"},"// 异常处理"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("e "),(0,t.Wm)("span",{class:"token operator"},"!="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"null"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n            promise"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"tryFailure"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("e"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n            "),(0,t.Wm)("span",{class:"token keyword"},"return"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n\n        "),(0,t.Wm)("span",{class:"token comment"},"// Lua 脚本返回的 delay 为 nil，说明成功取得了许可，所以 Future 结果为 true"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("delay "),(0,t.Wm)("span",{class:"token operator"},"=="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"null"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n            promise"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"trySuccess"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token boolean"},"true"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n            "),(0,t.Wm)("span",{class:"token keyword"},"return"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n\n        "),(0,t.Wm)("span",{class:"token comment"},"// 如果方法调用时没有传入超时配置，则设置一个 delay 毫秒之后的定时任务，到指定时刻后才进行重试"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("timeoutInMillis "),(0,t.Wm)("span",{class:"token operator"},"=="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"-"),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n            commandExecutor"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"getConnectionManager"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"getGroup"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"schedule"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"->"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n                "),(0,t.Wm)("span",{class:"token function"},"tryAcquireAsync"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token keyword"},"permits"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" promise"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" timeoutInMillis"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n            "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" delay"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"TimeUnit"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("MILLISECONDS"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n            "),(0,t.Wm)("span",{class:"token keyword"},"return"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n\n        "),(0,t.Wm)("span",{class:"token comment"},"// 如果方法调用时设置了超时参数，则只能在设定的时间段内进行重试"),(0,t.Uk)("\n\n        "),(0,t.Wm)("span",{class:"token comment"},"// 计算之前的尝试已经花费了多长时间"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(" el "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"System"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"currentTimeMillis"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"-"),(0,t.Uk)(" s"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token comment"},"// 计算还有多少时间可以用来重试"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(" remains "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" timeoutInMillis "),(0,t.Wm)("span",{class:"token operator"},"-"),(0,t.Uk)(" el"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token comment"},"// 已经没有时间了，所以就是指定时间内无法获取指定数量的许可，直接将 Future 结果设置为 false"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("remains "),(0,t.Wm)("span",{class:"token operator"},"<="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"0"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n            promise"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"trySuccess"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token boolean"},"false"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n            "),(0,t.Wm)("span",{class:"token keyword"},"return"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token comment"},"// 如果剩余的时间不足以等待到下一次可以重试的时间，说明无法进行下一次重试，创建一个定时任务，在剩余时间结束之后才将 Future 结果设置为 false"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token comment"},"// 这里没有直接提交 Future 结果，而是做了一个延时，这一点在接口的 JavaDoc 中有提到"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token comment"},"// 这样设计可能是为了出让 CPU 给其它线程，优先让其它线程完成任务"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("remains "),(0,t.Wm)("span",{class:"token operator"},"<"),(0,t.Uk)(" delay"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n            commandExecutor"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"getConnectionManager"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"getGroup"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"schedule"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"->"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n                promise"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"trySuccess"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token boolean"},"false"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n            "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" remains"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"TimeUnit"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("MILLISECONDS"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"else"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n            "),(0,t.Wm)("span",{class:"token comment"},"// 剩下的时间足以进行下一次重试，先记录下当前时间"),(0,t.Uk)("\n            "),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(" start "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"System"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"currentTimeMillis"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n            "),(0,t.Wm)("span",{class:"token comment"},"// 设置 delay 毫秒后进行下一次尝试"),(0,t.Uk)("\n            commandExecutor"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"getConnectionManager"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"getGroup"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"schedule"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"->"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n                "),(0,t.Wm)("span",{class:"token comment"},"// 由于线程调度，实际执行这里的逻辑时，过去的时间可能大于 delay，所以这里要计算实际得到调度时过去的时间"),(0,t.Uk)("\n                "),(0,t.Wm)("span",{class:"token keyword"},"long"),(0,t.Uk)(" elapsed "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"System"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"currentTimeMillis"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"-"),(0,t.Uk)(" start"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n                "),(0,t.Wm)("span",{class:"token comment"},"// 如果得到线程调度时过去的时间太长，直接设置 Future 结果为 false"),(0,t.Uk)("\n                "),(0,t.Wm)("span",{class:"token keyword"},"if"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("remains "),(0,t.Wm)("span",{class:"token operator"},"<="),(0,t.Uk)(" elapsed"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n                    promise"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"trySuccess"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token boolean"},"false"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n                    "),(0,t.Wm)("span",{class:"token keyword"},"return"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n                "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n\n                "),(0,t.Wm)("span",{class:"token comment"},"// 有足够的时间进行尝试，就递归调用本方法，进行下一次操作"),(0,t.Uk)("\n                "),(0,t.Wm)("span",{class:"token function"},"tryAcquireAsync"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token keyword"},"permits"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" promise"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" remains "),(0,t.Wm)("span",{class:"token operator"},"-"),(0,t.Uk)(" elapsed"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n            "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(" delay"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"TimeUnit"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("MILLISECONDS"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n        "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n    "),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t.Wm)("div",{class:"line-numbers"},[(0,t.Wm)("span",{class:"line-number"},"1"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"2"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"3"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"4"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"5"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"6"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"7"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"8"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"9"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"10"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"11"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"12"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"13"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"14"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"15"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"16"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"17"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"18"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"19"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"20"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"21"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"22"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"23"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"24"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"25"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"26"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"27"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"28"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"29"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"30"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"31"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"32"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"33"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"34"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"35"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"36"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"37"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"38"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"39"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"40"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"41"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"42"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"43"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"44"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"45"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"46"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"47"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"48"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"49"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"50"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"51"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"52"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"53"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"54"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"55"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"56"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"57"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"58"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"59"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"60"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"61"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"62"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"63"),(0,t.Wm)("br")])],-1),rn=(0,t.Wm)("p",null,"可以看到，实现阻塞获取许可的基本思路就是在指定的超时时间内进行反复的轮询重试。也许每一个工程师都清楚阻塞获取许可需要这么干，但 Redisson 源码中的各种细节值得我们学习。",-1),Un=(0,t.Wm)("blockquote",null,[(0,t.Wm)("p",null,[(0,t.Uk)("在有超时配置的方法的 JavaDoc 上，都有说到 “If no permit is available then the current thread becomes disabled for thread scheduling purposes and lies dormant until specified waiting time elapses”。我的理解是，当 "),(0,t.Wm)("code",null,"remains < delay"),(0,t.Uk)(" 成立时会让线程进入休眠，并在 "),(0,t.Wm)("code",null,"remains"),(0,t.Uk)(" 毫秒之后才将 "),(0,t.Wm)("code",null,"Future"),(0,t.Uk)(" 结果设置为 "),(0,t.Wm)("code",null,"false"),(0,t.Uk)("，但源码中似乎并没有让当前线程进入休眠状态，也没有禁止它被调度。")]),(0,t.Wm)("p",null,[(0,t.Uk)("这里可能涉及到 netty（很惭愧，我还没有学过），我做了一个小测试，"),(0,t.Wm)("code",null,"commandExecutor.getConnectionManager().getGroup().schedule"),(0,t.Uk)(" 似乎并不会让线程 “disabled for thread scheduling purposes”。")]),(0,t.Wm)("div",{class:"language-java ext-java line-numbers-mode"},[(0,t.Wm)("pre",{class:"language-java"},[(0,t.Wm)("code",null,[(0,t.Wm)("span",{class:"token annotation punctuation"},"@Test"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token keyword"},"void"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token function"},"testSchedule"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token keyword"},"throws"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"Exception"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"{"),(0,t.Uk)("\n "),(0,t.Wm)("span",{class:"token class-name"},"RRateLimiter"),(0,t.Uk)(" rateLimiter "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(" redissonClient"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"getRateLimiter"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("KEY_NAME"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n "),(0,t.Wm)("span",{class:"token class-name"},"Field"),(0,t.Uk)(" field "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"RedissonObject"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token keyword"},"class"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"getDeclaredField"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},'"commandExecutor"'),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n field"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"setAccessible"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token boolean"},"true"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n "),(0,t.Wm)("span",{class:"token class-name"},"CommandAsyncExecutor"),(0,t.Uk)(" commandExecutor "),(0,t.Wm)("span",{class:"token operator"},"="),(0,t.Uk)(),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token class-name"},"CommandAsyncExecutor"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(" field"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"get"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Uk)("rateLimiter"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n commandExecutor"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"getConnectionManager"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"getGroup"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"schedule"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"->"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"System"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("out"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"println"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token class-name"},"LocalDateTime"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"now"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"+"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},'" 2s"'),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"2"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"TimeUnit"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("SECONDS"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n commandExecutor"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"getConnectionManager"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"getGroup"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"schedule"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"->"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"System"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("out"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"println"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token class-name"},"LocalDateTime"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"now"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token operator"},"+"),(0,t.Uk)(),(0,t.Wm)("span",{class:"token string"},'" 1s"'),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token number"},"1"),(0,t.Wm)("span",{class:"token punctuation"},","),(0,t.Uk)(),(0,t.Wm)("span",{class:"token class-name"},"TimeUnit"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("SECONDS"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n "),(0,t.Wm)("span",{class:"token class-name"},"System"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Uk)("out"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"println"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token string"},'"lalala"'),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n\n "),(0,t.Wm)("span",{class:"token class-name"},"Thread"),(0,t.Wm)("span",{class:"token punctuation"},"."),(0,t.Wm)("span",{class:"token function"},"sleep"),(0,t.Wm)("span",{class:"token punctuation"},"("),(0,t.Wm)("span",{class:"token number"},"3_000"),(0,t.Wm)("span",{class:"token punctuation"},")"),(0,t.Wm)("span",{class:"token punctuation"},";"),(0,t.Uk)("\n"),(0,t.Wm)("span",{class:"token punctuation"},"}"),(0,t.Uk)("\n")])]),(0,t.Wm)("div",{class:"line-numbers"},[(0,t.Wm)("span",{class:"line-number"},"1"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"2"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"3"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"4"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"5"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"6"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"7"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"8"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"9"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"10"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"11"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"12"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"13"),(0,t.Wm)("br")])]),(0,t.Wm)("p",null,"运行结果："),(0,t.Wm)("div",{class:"language-text ext-text line-numbers-mode"},[(0,t.Wm)("pre",{class:"language-text"},[(0,t.Wm)("code",null,"lalala\n2021-06-02T19:38:55.971 1s\n2021-06-02T19:38:56.968 2s\n")]),(0,t.Wm)("div",{class:"line-numbers"},[(0,t.Wm)("span",{class:"line-number"},"1"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"2"),(0,t.Wm)("br"),(0,t.Wm)("span",{class:"line-number"},"3"),(0,t.Wm)("br")])]),(0,t.Wm)("p",null,"此处存疑，或许之后要再回头研究。")],-1),bn=(0,t.Wm)("h2",{id:"其它思考",tabindex:"-1"},[(0,t.Wm)("a",{class:"header-anchor",href:"#其它思考","aria-hidden":"true"},"#"),(0,t.Uk)(" 其它思考")],-1),dn=(0,t.Wm)("h3",{id:"关于-redisson-所用数据结构的思考",tabindex:"-1"},[(0,t.Wm)("a",{class:"header-anchor",href:"#关于-redisson-所用数据结构的思考","aria-hidden":"true"},"#"),(0,t.Uk)(" 关于 Redisson 所用数据结构的思考")],-1),gn=(0,t.Wm)("p",null,[(0,t.Uk)("为什么许可发放记录表要使用 ZSet 而不是 List 呢？ZSet 中存放的是随机数和时间戳，这里的随机数还存在发生碰撞的可能，直接用 List 存储时间戳不是更好吗？使用 ZSet 最大的好处，就是可以通过 "),(0,t.Wm)("code",null,"zremrangebyscore"),(0,t.Uk)(" 命令来批量移除当前限流窗口之外的记录，时间复杂度为 "),(0,t.Wm)("code",null,"O(log(N)+M)"),(0,t.Uk)("，而如果改用 List，就只能一条一条地删除了（并且需要多次读取），时间复杂度为 "),(0,t.Wm)("code",null,"O(N)"),(0,t.Uk)("。由此看来，ZSet 确实优于 List。")],-1),yn=(0,t.Wm)("p",null,[(0,t.Uk)("此外，Redisson 专门使用了一个 String 来存放当前剩余的可用许可数，每一次操作时都要维护它的值，计算公式为 "),(0,t.Wm)("code",null,"剩余可用许可数 = 限流阈值 - 许可发放记录表长度"),(0,t.Uk)("。既然它的值是根据限流器配置和许可发放记录表来计算的，为何不将它省掉呢？我暂时想不到答案，也懒得去提 issue 问这种问题， 也许他们单纯只是觉得这样写起来更方便吧。")],-1),wn=(0,t.Wm)("h3",{id:"时间差问题",tabindex:"-1"},[(0,t.Wm)("a",{class:"header-anchor",href:"#时间差问题","aria-hidden":"true"},"#"),(0,t.Uk)(" 时间差问题")],-1),fn=(0,t.Wm)("p",null,"机器间的时钟差异，以及网络延时，都有可能引发时间差问题。",-1),Rn=(0,t.Wm)("p",null,"可能会存在这样的情况：",-1),vn=(0,t.Wm)("ol",null,[(0,t.Wm)("li",null,"需要对某操作 O 进行全局性的每秒 1 次限流。"),(0,t.Wm)("li",null,[(0,t.Uk)("机器 A 在时刻 1000 请求许可，并顺利取得许可，此时许可发放记录被更新为 "),(0,t.Wm)("code",null,"[1000]"),(0,t.Uk)("。")]),(0,t.Wm)("li",null,[(0,t.Uk)("机器 B 在时刻 2100 请求许可，由于许可发放记录中的 "),(0,t.Wm)("code",null,"1000"),(0,t.Uk)(" 在限流窗口之外，所以机器 B 也取得了许可。")]),(0,t.Wm)("li",null,"由于网络波动，两台机器都在时刻 2500 才得到响应，然后同时执行了操作 O。")],-1),An=(0,t.Wm)("p",null,[(0,t.Uk)("上面这个例子，是极端状况下由于网络延时而引发的限流失效。而由于 Redisson 使用的是 Java 程序传入的 "),(0,t.Wm)("code",null,"System.currentTimeMillis()"),(0,t.Uk)("，所以机器间的时间差异同样可能会引发限流失效。")],-1),Tn=(0,t.Wm)("p",null,"针对网络延时的问题，我们可以在程序中根据网络请求、响应时间进行判断，假如响应耗时过长，则认为这一次许可申请是无效的（实际上使用带超时参数的方法即可）。",-1),hn=(0,t.Wm)("p",null,"而针对机器时间差异的问题，最好的办法应该是在运维层面定时地统一各机器的时间。",-1),En=(0,t.Wm)("h3",{id:"限流器配置改变的可见性问题",tabindex:"-1"},[(0,t.Wm)("a",{class:"header-anchor",href:"#限流器配置改变的可见性问题","aria-hidden":"true"},"#"),(0,t.Uk)(" 限流器配置改变的可见性问题")],-1),Nn=(0,t.Wm)("p",null,"假如限流器的配置是每小时 1 次，若某个线程执行阻塞的许可申请方法，则它在获取不到许可时，可能会在比较长的一段时间之后才进行重试。在它等待的这段时间之内，假如限流器的配置被修改为每秒钟 1 次，这一修改对这个线程是不可见的，它仍然会在漫长的等待之后才进行重试。",-1),Ln=(0,t.Wm)("p",null,"当然，在实际应用中类似的场景应该是极少的，就算出现了，应该也无伤大雅。",-1),Sn={render:function(n,s){return(0,t.wg)(),(0,t.j4)(t.HY,null,[o,c,m,l,p,k,u,W,i,r,U,b,d,g,y,w,f,R,v,A,T,h,E,N,L,S,C,x,I,j,G,q,V,K,M,Y,F,O,z,B,X,D,P,J,Z,H,Q,_,$,nn,sn,an,tn,en,on,cn,mn,ln,pn,kn,un,Wn,rn,Un,bn,dn,gn,yn,wn,fn,Rn,vn,An,Tn,hn,En,Nn,Ln],64)}}}}]);